{{- if .Values.cephcluster.monitoring.enabled -}}
{{/*
RBAC needed for enabling monitoring for a Rook CephCluster.
These should be scoped to the namespace where the CephCluster is located.
*/}}
kind: Role
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: rook-ceph-monitoring
  namespace: {{ .Release.Namespace }} # namespace:cluster
rules:
  - apiGroups:
      - "monitoring.coreos.com"
    resources:
      - servicemonitors
    verbs:
      - get
      - list
      - watch
      - create
      - update
      - delete
---
# Allow management of monitoring resources in the mgr
kind: Role
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: rook-ceph-monitoring-mgr
  namespace: {{ .Release.Namespace }} # namespace:cluster
rules:
  - apiGroups:
      - monitoring.coreos.com
    resources:
      - servicemonitors
    verbs:
      - get
      - list
      - create
      - update
---
# Allow the operator to get ServiceMonitors in this cluster's namespace
kind: RoleBinding
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: rook-ceph-monitoring
  namespace: {{ .Release.Namespace }} # namespace:cluster
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: rook-ceph-monitoring
subjects:
  - kind: ServiceAccount
    name: rook-ceph-system
    namespace: {{ .Values.operatorNamespace | default .Release.Namespace }} # namespace:operator
---
# Allow creation of monitoring resources in the mgr
kind: RoleBinding
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: rook-ceph-monitoring-mgr
  namespace: {{ .Release.Namespace }} # namespace:cluster
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: rook-ceph-monitoring-mgr
subjects:
  - kind: ServiceAccount
    name: rook-ceph-mgr
    namespace: {{ .Release.Namespace }} # namespace:cluster
---
### Prometheus Pod in openshift-monitoring mit ServiceAccount prometheus-k8s muss Berechtigungen haben um auf rook-ceph namespace zugreifen zu k√∂nnen.
### Mit diesen Berechtigungen findet Prometheus die Pods welche gescraped werden sollen.
kind: Role
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: prometheus-k8s
  namespace: {{ .Release.Namespace }}
rules:
  - verbs:
      - get
      - list
      - watch
    apiGroups:
      - ''
    resources:
      - services
      - endpoints
      - pods
---
kind: RoleBinding
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: prometheus-k8s
  namespace: {{ .Release.Namespace }}
subjects:
  - kind: ServiceAccount
    name: prometheus-k8s
    namespace: openshift-monitoring
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: prometheus-k8s
---
# ServiceMonitor to scrape prometheus metrics
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: rook-ceph-mgr
  namespace: {{ .Release.Namespace }}
spec:
  namespaceSelector:
    matchNames:
      - {{ .Release.Namespace }}
  selector:
    matchLabels:
      app: rook-ceph-mgr
      rook_cluster: rook-ceph
  endpoints:
    - port: http-metrics
      path: /metrics
      interval: 5s
---
{{- if .Values.cephcluster.alerts.enabled -}}
# Slack Secret for Rook-Ceph Alerts
apiVersion: bitnami.com/v1alpha1
kind: SealedSecret
metadata:
  name: slack-hook
  namespace: {{ .Release.Namespace }}
spec:
  encryptedData:
    url:  {{ .Values.cephcluster.alerts.slackurl }}
  template:
    metadata:
      creationTimestamp: null
      name: slack-hook
      namespace: {{ .Release.Namespace }}
---
apiVersion: monitoring.coreos.com/v1alpha1
kind: AlertmanagerConfig
metadata:
  name: critical-alerts-rook-ceph
  namespace: {{ .Release.Namespace }}
spec:
  route:
    receiver: slack-alert-reveiver
    groupBy: [job]
    matchers:
      - name: severity
        value: critical
        matchType: "="
  receivers:
    - name: slack-alert-reveiver
      slackConfigs:
        - channel: critical
          apiURL:
            name: slack-hook
            key: url
          title: "Rook-Ceph Alert"
          text: |-
            Themengebiet: STORAGE
            Summary: {{`{{ .CommonAnnotations.summary }}`}}
            Cluster: {{ .Values.cephcluster.alerts.environment }}
            Alerts:
            {{`{{- range .Alerts -}}`}}
              - {{`{{ .Annotations.description }}`}}
              - {{`{{ .Annotations.documentation }}`}}
            {{`{{- end -}}`}}
---
{{- if .Values.cephcluster.alerts.notifyWarning }}
apiVersion: monitoring.coreos.com/v1alpha1
kind: AlertmanagerConfig
metadata:
  name: warning-alerts-rook-ceph
  namespace: {{ .Release.Namespace }}
spec:
  route:
    receiver: slack-alert-reveiver
    groupBy: [job]
    matchers:
      - name: severity
        value: warning
        matchType: "="
  receivers:
    - name: slack-alert-reveiver
      slackConfigs:
        - channel: critical
          apiURL:
            name: slack-hook
            key: url
          title: "Rook-Ceph Alert"
          text: |-
            Themengebiet: STORAGE
            Summary: {{`{{ .CommonAnnotations.summary }}`}}
            Cluster: {{ .Values.cephcluster.environment }}
            Alerts:
            {{`{{- range .Alerts -}}`}}
              - {{`{{ .Annotations.description }}`}}
              - {{`{{ .Annotations.documentation }}`}}
            {{`{{- end -}}`}}
{{- end }}
{{- end }}
{{- end }}
